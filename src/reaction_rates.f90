!module reaction_rates
! module containing routines implementing the reaction rates

!   use numerics_parameters, only : Nx, switch_charge_exchange, switch_recombination, switch_ionization, switch_excitation, switch_recombenergy
!<<<<<<< HEAD
!   use physics_parameters,  only : charge_exchange_model, ionization_model, recombination_model, case_AMJUEL,  impurity_concentration,&
!           impurity_Z, num_impurities, minimum_temperature, minimum_density, mass, D_imp_con, prf_imp_con, E_imp_con

module reaction_rates
! module containing routines implementing the reaction rates
! License Notice
! This file is part of DIV1D.
! DIV1D is free software: you can redistribute it and/or modify it under the terms of the GNU Lesser General Public License 
! as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version.
!
! DIV1D is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty 
! of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public License for more details.
!
! You should have received a copy of the GNU Lesser General Public License along with DIV1D. 
! If not, see <https://www.gnu.org/licenses>. 


   use numerics_parameters, only : Nx, switch_charge_exchange, switch_recombination, switch_ionization, switch_excitation, switch_recombenergy, &
				 switch_momentum_transfer_atoms, switch_ionization_molecules, switch_dissociation_molecules, switch_charge_exchange_molecules, &
				switch_dissociation_H2plus, switch_dissociative_recombination_H2plus, switch_dissociative_ionization_H2plus, mol_dens_model, &
	switch_momentum_transfer_molecules, switch_energy_molecules, switch_dissociative_attachment, switch_charge_exchange_Hmin, switch_ionization_Hmin
   use physics_parameters,  only : charge_exchange_model, ionization_model, recombination_model, case_AMJUEL, D_imp_con, prf_imp_con, impurity_Z, num_impurities, &
                                   minimum_temperature, minimum_density, mass
   use constants,           only : e_charge
   use radiative_cooling_functions_post1977

   implicit none
   integer, parameter, private :: wp = KIND(1.0D0)

   ! See page XX of AMJUEL for definition of the fit functions and variables (T in eV; density in 10^14 /m^3; resulting rates <sigma v> in cm^3/s
!   ! the coefficients for the charge exchange rate according to AMJUEL 2.1 reaction 0.1T(Total)
!   real(wp), private, dimension(9)   :: cxa_coef = (/ &
!                -1.833882000000D+01,  2.368705000000D-01, -1.469575000000D-02, -1.139850000000D-02,  6.379644000000D-04,  3.162724000000D-04, -6.681994000000D-05,  3.812123000000D-06,  8.652321000000D-09 /)
   ! the coefficients for the charge exchange rate according to AMJUEL 2.19 reaction 3.1.8 page 43
   real(wp), private, dimension(9)   :: cxa_coef = (/ &
                -1.850280000000D+01,  3.708409000000D-01,  7.949876000000D-03, -6.143769000000D-04, -4.698969000000D-04, -4.096807000000D-04,  1.440382000000D-04, -1.514243000000D-05,  5.122435000000D-07 /)

!   ! the coefficients for the total hydrogen recombination rate according to AMJUEL 4.4 reaction 2.1.8 total rate including three-body recombination [m^3 / s]
!   real(wp), private, dimension(9,9) :: recomb_coef = reshape( (/  &
!                -2.855728479302D+01,  3.488563234375D-02, -2.799644392058D-02,  1.209545317879D-02, -2.436630799820D-03,  2.837893719800D-04, -1.886511169084D-05,  6.752155602894D-07, -1.005893858779D-08, &
!                -7.664042607917D-01, -3.583233366133D-03, -7.452514292790D-03,  2.709299760454D-03, -7.745129766167D-04,  1.142444698207D-04, -9.382783518064D-06,  3.902800099653D-07, -6.387411585521D-09, &
!                -4.930424003280D-03, -3.620245352252D-03,  6.958711963182D-03, -2.139257298118D-03,  4.603883706734D-04, -5.991636837395D-05,  4.729262545726D-06, -1.993485395689D-07,  3.352589865190D-09, &
!                -5.386830982777D-03, -9.532840484460D-04,  4.631753807534D-04, -5.371179699661D-04,  1.543350502150D-04, -2.257565836876D-05,  1.730782954588D-06, -6.618240780594D-08,  1.013364275013D-09, &
!                -1.626039237665D-04,  1.888048628708D-04,  1.288577690147D-04, -1.634580516353D-05, -9.601036952725D-06,  3.425262385387D-06, -4.077019941998D-07,  2.042041097083D-08, -3.707977721109D-10, &
!                 6.080907650243D-06, -1.014890683861D-05, -1.145028889459D-04,  5.942193980802D-05, -1.211851723717D-05,  1.118965496365D-06, -4.275321573501D-08,  3.708616111085D-10,  7.068450112690D-12, &
!                 2.101102051942D-05,  2.245676563601D-05, -2.245624273814D-06, -2.944873763540D-06,  1.002105099354D-06, -1.291320799814D-07,  7.786155463269D-09, -2.441127783437D-10,  3.773208484020D-12, &
!                -2.770717597683D-06, -4.695982369246D-06,  3.250878872873D-06, -9.387290785993D-07,  1.392391630459D-07, -1.139093288575D-08,  5.178505597480D-10, -9.452402157390D-12, -4.672724022059D-14, &
!                 1.038235939800D-07,  2.523166611507D-07, -2.145390398476D-07,  7.381435237585D-08, -1.299713684966D-08,  1.265189576423D-09, -6.854203970018D-11,  1.836615031798D-12, -1.640492364811D-14 /), &
!             shape(recomb_coef), order=(/2,1/) )
   ! the coefficients for the total hydrogen recombination rate according to AMJUEL 4.6 reaction 2.1.8 total rate including three-body recombination [m^3 / s]
   real(wp), private, dimension(9,9) :: recomb_coef = reshape( (/  &
                -2.858858570847D+01,  2.068671746773D-02, -7.868331504755D-03,  3.843362133859D-03, -7.411492158905D-04,  9.273687892997D-05, -7.063529824805D-06,  3.026539277057D-07, -5.373940838104D-09, &
                -7.676413320499D-01,  1.278006032590D-02, -1.870326896978D-02,  3.828555048890D-03, -3.627770385335D-04,  4.401007253801D-07,  1.932701779173D-06, -1.176872895577D-07,  2.215851843121D-09, &
                 2.823851790251D-03, -1.907812518731D-03,  1.121251125171D-02, -3.711328186517D-03,  6.617485083301D-04, -6.860774445002D-05,  4.508046989099D-06, -1.723423509284D-07,  2.805361431741D-09, &
                -1.062884273731D-02, -1.010719783828D-02,  4.208412930611D-03, -1.005744410540D-03,  1.013652422369D-04, -2.044691594727D-06, -4.431181498017D-07,  3.457903389784D-08, -7.374639775683D-10, &
                 1.582701550903D-03,  2.794099401979D-03, -2.024796037098D-03,  6.250304936976D-04, -9.224891301052D-05,  7.546853961575D-06, -3.682709551169D-07,  1.035928615391D-08, -1.325312585168D-10, &
                -1.938012790522D-04,  2.148453735781D-04,  3.393285358049D-05, -3.746423753955D-05,  7.509176112468D-06, -8.688365258514D-07,  7.144767938783D-08, -3.367897014044D-09,  6.250111099227D-11, &
                 6.041794354114D-06, -1.421502819671D-04,  6.143879076080D-05, -1.232549226121D-05,  1.394562183496D-06, -6.434833988001D-08, -2.746804724917D-09,  3.564291012995D-10, -8.551708197610D-12, &
                 1.742316850715D-06,  1.595051038326D-05, -7.858419208668D-06,  1.774935420144D-06, -2.187584251561D-07,  1.327090702659D-08, -1.386720240985D-10, -1.946206688519D-11,  5.745422385081D-13, &
                -1.384927774988D-07, -5.664673433879D-07,  2.886857762387D-07, -6.591743182569D-08,  8.008790343319D-09, -4.805837071646D-10,  6.459706573699D-12,  5.510729582791D-13, -1.680871303639D-14 /), &
             shape(recomb_coef), order=(/2,1/) )

   ! the coefficients for the total hydrogen ionization rate according to AMJUEL 4.3 reaction 2.1.5 [m^3 / s]
   real(wp), private, dimension(9,9) :: ionize_coef = reshape( (/  &
                -3.248025330340D+01, -5.440669186583D-02,  9.048888225109D-02, -4.054078993576D-02,  8.976513750477D-03, -1.060334011186D-03,  6.846238436472D-05, -2.242955329604D-06,  2.890437688072D-08, &
                 1.425332391510D+01, -3.594347160760D-02, -2.014729121556D-02,  1.039773615730D-02, -1.771792153042D-03,  1.237467264294D-04, -3.130184159149D-06, -3.051994601527D-08,  1.888148175469D-09, &
                -6.632235026785D+00,  9.255558353174D-02, -5.580210154625D-03, -5.902218748238D-03,  1.295609806553D-03, -1.056721622588D-04,  4.646310029498D-06, -1.479612391848D-07,  2.852251258320D-09, &
                 2.059544135448D+00, -7.562462086943D-02,  1.519595967433D-02,  5.803498098354D-04, -3.527285012725D-04,  3.201533740322D-05, -1.835196889733D-06,  9.474014343303D-08, -2.342505583774D-09, &
                -4.425370331410D-01,  2.882634019199D-02, -7.285771485050D-03,  4.643389885987D-04,  1.145700685235D-06,  8.493662724988D-07, -1.001032516512D-08, -1.476839184318D-08,  6.047700368169D-10, &
                 6.309381861496D-02, -5.788686535780D-03,  1.507382955250D-03, -1.201550548662D-04,  6.574487543511D-06, -9.678782818849D-07,  5.176265845225D-08,  1.291551676860D-09, -9.685157340473D-11, &
                -5.620091829261D-03,  6.329105568040D-04, -1.527777697951D-04,  8.270124691336D-06,  3.224101773605D-08,  4.377402649057D-08, -2.622921686955D-09, -2.259663431436D-10,  1.161438990709D-11, &
                 2.812016578355D-04, -3.564132950345D-05,  7.222726811078D-06,  1.433018694347D-07, -1.097431215601D-07,  7.789031791949D-09, -4.197728680251D-10,  3.032260338723D-11, -8.911076930014D-13, &
                -6.011143453374D-06,  8.089651265488D-07, -1.186212683668D-07, -2.381080756307D-08,  6.271173694534D-09, -5.483010244930D-10,  3.064611702159D-11, -1.355903284487D-12,  2.935080031599D-14 /), &
             shape(ionize_coef), order=(/2,1/) )

   ! the coefficients for the total hydrogen excitation rate according to AMJUEL 10.2 reaction 2.1.5 effective cooling rate by ionization and radiation [eV m^3 / s]
   real(wp), private, dimension(9,9) :: excite_coef = reshape( (/  &
                -2.497580168306D+01,  1.081653961822D-03, -7.358936044605D-04,  4.122398646951D-04, -1.408153300988D-04,  2.469730836220D-05, -2.212823709798D-06,  9.648139704737D-08, -1.611904413846D-09, &
                 1.004448839974D+01, -3.189474633369D-03,  2.510128351932D-03, -7.707040988954D-04,  1.031309578578D-04, -3.716939423005D-06, -4.249704742353D-07,  4.164960852522D-08, -9.893423877739D-10, &
                -4.867952931298D+00, -5.852267850690D-03,  2.867458651322D-03, -8.328668093987D-04,  2.056134355492D-04, -3.301570807523D-05,  2.831739755462D-06, -1.164969298033D-07,  1.785440278790D-09, &
                 1.689422238067D+00,  7.744372210287D-03, -3.087364236497D-03,  4.707676288420D-04, -5.508611815406D-05,  7.305867762241D-06, -6.000115718138D-07,  2.045211951761D-08, -1.790312871690D-10, &
                -4.103532320100D-01, -3.622291213236D-03,  1.327415215304D-03, -1.424078519508D-04,  3.307339563081D-06,  5.256679519499D-09,  7.597020291557D-10,  1.799505288362D-09, -9.280890205774D-11, &
                 6.469718387357D-02,  8.268567898126D-04, -2.830939623802D-04,  2.411848024960D-05,  5.707984861100D-07, -1.016945693300D-07,  3.517154874443D-09, -4.453195673947D-10,  2.002478264932D-11, &
                -6.215861314764D-03, -9.836595524255D-05,  3.017296919092D-05, -1.474253805845D-06, -2.397868837417D-07,  1.518743025531D-08,  4.149084521319D-10, -6.803200444549D-12, -1.151855939531D-12, &
                 3.289809895460D-04,  5.845697922558D-06, -1.479323780613D-06, -4.633029022577D-08,  3.337390374041D-08, -1.770252084837D-09, -5.289806153651D-11,  3.864394776250D-12, -8.694978774411D-15, &
                -7.335808238917D-06, -1.367574486885D-07,  2.423236476442D-08,  5.733871119707D-09, -1.512777532459D-09,  8.733801272834D-11,  7.196798841269D-13, -1.441033650378D-13,  1.734769090475D-15 /), &
             shape(excite_coef), order=(/2,1/) )

   ! the coefficients for the cooling rate according to AMJUEL 10.4 reaction 2.1.8 effective electron cooling rate by rad.+3-body recombination (excl. 13.6 eV potential energy per recomb.) [eV m^3 / s]
   real(wp), private, dimension(9,9) :: recnrg_coef = reshape( (/  &
                -2.592450349909E+01,  1.222097271874E-02,  4.278499401907E-05,  1.943967743593E-03, -7.123474602102E-04,  1.303523395892E-04, -1.186560752561E-05,  5.334455630031E-07, -9.349857887253E-09, &
                -7.290670236493E-01, -1.540323930666E-02, -3.406093779190E-03,  1.532243431817E-03, -4.658423772784E-04,  5.972448753445E-05, -4.070843294052E-06,  1.378709880644E-07, -1.818079729166E-09, &
                 2.363925869096E-02,  1.164453346305E-02, -5.845209334594E-03,  2.854145868307E-03, -5.077485291132E-04,  4.211106637742E-05, -1.251436618314E-06, -1.626555745259E-08,  1.073458810743E-09, &
                 3.645333930947E-03, -1.005820792983E-03,  6.956352274249E-04, -9.305056373739E-04,  2.584896294384E-04, -3.294643898894E-05,  2.112924018518E-06, -6.544682842175E-08,  7.810293075700E-10, &
                 1.594184648757E-03, -1.582238007548E-05,  4.073695619272E-04, -9.379169243859E-05,  1.490890502214E-06,  2.245292872209E-06, -3.150901014513E-07,  1.631965635818E-08, -2.984093025695E-10, &
                -1.216668033378E-03, -3.503070140126E-04,  1.043500296633E-04,  9.536162767321E-06, -6.908681884097E-06,  8.232019008169E-07, -2.905331051259E-08, -3.169038517749E-10,  2.442765766167E-11, &
                 2.376115895241E-04,  1.172709777146E-04, -6.695182045674E-05,  1.188184006210E-05, -4.381514364966E-07, -6.936267173079E-08,  6.592249255001E-09, -1.778887958831E-10,  1.160762106747E-12, &
                -1.930977636766E-05, -1.318401491304E-05,  8.848025453481E-06, -2.072370711390E-06,  2.055919993599E-07, -7.489632654212E-09, -7.073797030749E-11,  1.047087505147E-11, -1.877446271350E-13, &
                 5.599257775146E-07,  4.977823319311E-07, -3.615013823092E-07,  9.466989306497E-08, -1.146485227699E-08,  6.772338917155E-10, -1.776496344763E-11,  7.199195061382E-14,  3.929300283002E-15 /), &
             shape(recnrg_coef), order=(/2,1/) )

   ! the coefficients for the charge exchange rate from Freeman and Jones CLM-R-137 Table 3
   real(wp), private, dimension(9)   :: cxf_coef = (/ &
                -1.841757d+01, 5.282950d-01, -2.200477d-01, 9.750192d-02, -1.749183d-02, 4.954296d-04, 2.174910d-04, -2.530206d-05, 8.230751d-07 /)

   ! the coefficients for the ionization rate from Freeman and Jones CLM-R-137 Table 3
   real(wp), private, dimension(7)   :: ifj_coef = (/ &
                -0.3173850d+2, 0.1143818d+2, -0.3833998d+1, 0.7046692d+0, -0.7431486d-1, 0.4153749d-2, -0.9486967d-4 /)

	! the coefficients for elastic momentum transfer between ions and atoms (according to AMJUEL H.3 Reaction 0.1D)
   real(wp), private, dimension(9,9) :: el_mom_a_coef = reshape( (/ & 
		-1.934778779385D+01,  2.193162842747D-02, -5.787610534513D-04, -9.555854995025D-03, -3.071069026823D-03,  5.668304238739D-04,  1.023499873278D-04, -4.375997865613D-05,  3.554762032992D-06, &
 		 8.400121290584D-04, -5.025758478606D-02,  9.405606314808D-03,  1.213464571187D-02, -3.615417883123D-03, -8.289738887452D-04,  4.794896057762D-04, -7.011568552117D-05,  3.413857855011D-06, &
		-1.072570686950D-02,  1.258217951174D-02, -7.629292880371D-03, -3.222678509228D-03,  2.181349883244D-03,  1.491076548317D-04, -2.352460376261D-04,  4.210499686989D-05, -2.314387560956D-06, &
		-7.329656452946D-03,  1.017355462044D-02, -2.212101744320D-03, -4.530314087059D-03,  1.707627243838D-03,  3.285319171515D-04, -2.365796504952D-04,  3.759133611684D-05, -1.934588738006D-06, &
		-1.548110966373D-03, -4.141816249813D-03,  1.623377903131D-03,  1.894095127078D-03, -8.173359548467D-04, -1.268607651578D-04,  1.083092577128D-04, -1.817871861306D-05,  9.758474990215D-07, &
 		 8.780715214347D-05, -5.483013774324D-04,  1.371503461028D-04,  2.806873100807D-04, -1.147859100868D-04, -2.036026302326D-05,  1.584828965214D-05, -2.554030249359D-06,  1.314431146313D-07, &
 		 6.351915617491D-05,  4.711920962053D-04, -1.702351291260D-04, -2.386998803904D-04,  9.947217842552D-05,  1.676927171418D-05, -1.358046593907D-05,  2.254690862488D-06, -1.202340694084D-07, &
		-1.071915622348D-05, -7.653900655552D-05,  2.828377077442D-05,  3.936468195914D-05, -1.609704117822D-05, -2.801579443731D-06,  2.216781743757D-06, -3.678764178035D-07,  1.970465840287D-08, &
		 5.468789447600D-07,  3.989227802803D-06, -1.457895095025D-06, -2.077060263537D-06,  8.298532548793D-07,  1.504259503231D-07, -1.154459633382D-07,  1.906633038081D-08, -1.021379321893D-09 /), &
		shape(el_mom_a_coef), order=(/2,1/) )

   real(wp), private, dimension(9,9)  :: iona_coef_m = reshape( (/  &
		-3.574773783577D+01,  3.470247049909D-01, -9.683166540937D-02,  1.959576276250D-03,  2.479361119190D-03, -1.196632952666D-04, -1.862956119592D-05,  1.669867158509D-06, -3.673736278200D-08, &
 		1.769208985507D+01, -1.311169841222D+00,  4.700486215943D-01, -5.521175478827D-02, -2.689651616933D-03,  7.308915874002D-04, -2.920560755694D-05, -3.148831240316D-07,  2.514856386324D-08, &
		-8.291764008409D+00,  1.591701525694D+00, -5.814996025336D-01,  9.160898084105D-02, -4.770789631868D-03,  1.994775632224D-05, -7.511552245648D-06,  1.089689676313D-06, -2.920863498031D-08, &
 		2.555712347240D+00, -8.625268584825D-01,  2.612076696684D-01, -3.686525285376D-02,  1.945480608139D-03, -3.690918356665D-05,  4.836340453567D-06, -4.165748666929D-07,  9.265898224345D-09, &
		-5.370404654062D-01,  2.375816996323D-01, -4.165908778170D-02,  1.732469114063D-03,  3.693513203529D-04, -4.931268184607D-05,  2.727501534044D-06, -1.081027384449D-07,  2.420509440644D-09, &
		 7.443307905391D-02, -3.322214182214D-02, -2.351235556666D-03,  1.723053881691D-03, -2.096625925098D-04,  1.358575558294D-05, -1.041586202167D-06,  6.928574330531D-08, -1.746656185835D-09, &
		-6.391785721973D-03,  1.862554278190D-03,  1.540632467396D-03, -3.547150770477D-04,  1.392157055273D-05,  1.047463944093D-06,  1.513510667993D-08, -9.915499708242D-09,  3.298173891188D-10, &
		 3.001729098239D-04,  3.497202259366D-05, -1.742029226138D-04,  2.296551698214D-05,  2.357520372192D-06, -5.306085513950D-07,  2.223137028418D-08,  3.340169309800D-10, -2.560542889504D-11, &
		-5.607182991432D-06, -5.779550092391D-06,  6.495742927455D-06, -3.040011333889D-07, -2.361542565281D-07,  3.655056080262D-08, -1.771478792301D-09,  1.334615260635D-11,  6.831564719957D-13 /), &
             shape(iona_coef_m), order=(/2,1/) )
			

	real(wp), private, dimension(9,9)  :: diss_coef_m = reshape( (/  &
		-2.748251723699D+01,  5.245554722385D-04, -2.978103958861D-04, -2.360275829176D-07,  2.352410977770D-05, -4.997866180134D-06,  4.276219304407D-07, -1.656742885479D-08,  2.414039859152D-10, &
		 1.032713102402D+01, -4.288853521030D-04, -4.899568733097D-04,  4.986004995584D-04, -1.488915435909D-04,  2.064670043755D-05, -1.483657661440D-06,  	5.231689914639D-08, -7.056262049968D-10, &
		-5.042872981718D+00,  2.836621770958D-03, -3.043912367565D-03,  1.292894496252D-03, -2.905449411133D-04,  3.788502709678D-05, -2.892758625724D-06,  	1.174418148176D-07, -1.927933996765D-09, &
	 1.608638174175D+00, -1.261120000328D-03,  1.887422712154D-03, -9.327238099803D-04,  2.128634474527D-04, -2.509788157193D-05,  1.553010173585D-06, -4.703323705313D-08,  5.371568383284D-10, &
	-4.314430346833D-01, -8.545622758573D-04,  7.288308305238D-04, -2.484715070595D-04,  4.842155320136D-05, -6.186008058267D-06,  5.102144895277D-07, -2.321199392340D-08,  4.255457918971D-10, &
	 9.436567726730D-02,  3.330555462733D-04, -3.941114594575D-04,  1.711527657525D-04, -3.637820737985D-05,  4.163286478680D-06, -2.597547413556D-07,  8.256194712004D-09, -1.040875802194D-10, &
	-1.384992697339D-02,  5.154637596963D-06,  2.704571960637D-05, -2.084393307530D-05,  5.401855723043D-06, -6.247464789742D-07,  3.214084295485D-08, -5.485492350310D-10, -2.766340477990D-12, &
	 1.132016190295D-03, -1.288164830284D-05,  7.769128981290D-06, -1.221455182210D-06, -3.231445161484D-09,  9.993216378891D-09,  1.346287938920D-10, -7.497501425175D-11,  2.502198014796D-12, &
	-3.842014088368D-05,  1.171737695451D-06, -9.017007769431D-07,  2.476534052706D-07, -3.367686347533D-08,  2.869160964443D-09, -1.931319268617D-10,  9.102276313210D-12, -1.872646131609D-13 /), &
             shape(diss_coef_m), order=(/2,1/) )


	real(wp), private, dimension(9)   :: cxa_coef_m = (/ &
   		-2.163099643422D+01, 3.206843053514D+00, -3.369939911269D+00, 1.290238400703D+00, -3.988189754178D-01, 1.462287796966D-01, -3.524154596754D-02, 4.146324082808D-03, -1.846022446828D-04 /)


	real(wp), private, dimension(9,9)  :: diss_coef_H2plus = reshape( (/  &
-1.793443274600D+01, -4.932783688604D-02,  1.039088280849D-01, -4.375935166008D-02,  9.196691651936D-03, -1.043378648769D-03,  6.600342421838D-05, -2.198466460165D-06,  3.004145701249D-08, &
 2.236108757681D+00, -2.545406018621D-02, -1.160421006835D-01,  4.407846563362D-02, -8.192521304984D-03,  8.200277386433D-04, -4.508284363534D-05,  1.282824614809D-06, -1.474719350236D-08, &
-3.620018994703D-01,  6.721527680150D-02,  1.564387124002D-02, -4.939045440424D-03,  4.263195867947D-04,  1.034216805418D-05, -3.975028601900D-06,  2.322116289258D-07, -4.381217154470D-09, &
-4.353922258965D-01, -3.051033606589D-02,  3.512861172521D-02, -1.179504564265D-02,  2.091772760029D-03, -1.991100044575D-04,  1.018080238045D-05, -2.597941866088D-07,  2.524118386011D-09, &
 1.580381801957D-01,  2.493654957203D-03, -1.601970998119D-02,  5.346709597939D-03, -8.711870134835D-04,  7.542066727545D-05, -3.410778344979D-06,  7.120460603822D-08, -4.412295474522D-10, &
 1.697880687685D-02,  2.106675963900D-03,  4.521983358170D-04, -3.017151690655D-04,  6.209239389357D-05, -7.598119096817D-06,  5.523273241689D-07, -2.130508249251D-08,  3.319099650589D-10, &
-1.521914651109D-02, -7.527862162788D-04,  9.095551479381D-04, -2.372576223034D-04,  3.018561480848D-05, -1.365255868731D-06, -4.604769733903D-08,  5.867910270430D-09, -1.357779142836D-10, &
 2.406276368070D-03,  9.971361856278D-05, -1.760978402353D-04,  4.877659148871D-05, -6.477358351729D-06,  3.541106430252D-07,  1.309772899670D-09, -8.072907334230D-10,  2.074669430611D-11, &
-1.219469579955D-04, -4.785505675232D-06,  9.858840337511D-06, -2.779210878533D-06,  3.720379996058D-07, -2.110289928486D-08,  3.753875073646D-11,  4.024906665497D-11, -1.075990572574D-12 /), &
             shape(diss_coef_H2plus), order=(/2,1/) )

	real(wp), private, dimension(9,9)  :: diss_rec_coef_H2plus = reshape( (/  &
-1.664335253647D+01,  8.953780953631D-02, -1.056411030518D-01,  4.477000808690D-02, -9.729945434357D-03,  1.174456882002D-03, -7.987743820637D-05,  2.842957892768D-06, -4.104508608435D-08, &
-6.005444031657D-01,  4.063933992726D-02, -4.753947846841D-02,  2.188304031377D-02, -5.201085606791D-03,  6.866340394051D-04, -5.059940013116D-05,  1.930213882205D-06, -2.963966822809D-08, &
 4.494812032769D-04,  7.884508616595D-05,  3.688007562485D-04, -4.659255785539D-04,  1.907115980400D-04, -3.434324710145D-05,  3.067651560323D-06, -1.325689465590D-07,  2.212493073620D-09, &
 1.632894866655D-04,  3.108116177617D-04, -3.521552580917D-04, -2.233169775063D-04,  1.869415236037D-04, -4.329991211511D-05,  4.465256901322D-06, -2.136296167564D-07,  3.873085368404D-09, &
-7.234142549752D-05, -1.316311320262D-03,  1.643509328764D-03, -6.412764282779D-04,  1.048891053765D-04, -7.018555173322D-06,  4.776213235854D-08,  1.380537343974D-08, -4.199397846492D-10, &
-1.504085050039D-05,  1.315865970237D-04, -1.025653773999D-04,  5.310324781249D-05, -1.831888048039D-05,  3.423755373077D-06, -3.303384352061D-07,  1.551627097700D-08, -2.809391819541D-10, &
 1.113923667684D-05,  2.711411525392D-05, -8.495922363727D-05,  4.026487801017D-05, -6.289324474240D-06,  1.911447036702D-07,  3.638198230235D-08, -3.235540606394D-09,  7.605442050634D-11, &
-1.843926162250D-06, -1.663674537499D-06,  1.308069926896D-05, -7.324021449032D-06,  1.431739868187D-06, -1.085644779665D-07,  1.143164983367D-09,  2.151595003971D-10, -7.052562220005D-12, &
 9.864173150662D-08, -2.212261708468D-07, -4.431749501051D-07,  3.270530731011D-07, -7.282085521177D-08,  6.578253567957D-09, -1.925258267827D-10, -4.217474167519D-12,  2.364754029318D-13 /), &
             shape(diss_rec_coef_H2plus), order=(/2,1/) )

	real(wp), private, dimension(9,9)  :: diss_ion_coef_H2plus = reshape( (/  &
-3.708803769397D+01,  9.784233987341D-02, -7.200361272130D-03,  6.496843022778D-03, -1.420590818760D-03,  1.703620321164D-04, -1.160738946400D-05,  4.148222302162D-07, -6.007853385325D-09, &
 1.561780529774D+01, -1.673256230592D-02,  2.743322772895D-02, -1.026956102747D-02,  1.999561527383D-03, -2.043607814503D-04,  1.084177127603D-05, -2.671800995803D-07,  2.093182411476D-09, &
-6.874406034117D+00, -7.782929961315D-03, -6.888773684846D-03,  2.306107197863D-03, -4.029222834436D-04,  3.932152471491D-05, -2.094907364150D-06,  5.682907060010D-08, -6.320752545610D-10, &
 2.010540060675D+00, -3.226785148562D-03, -6.181192193854D-03,  2.388146990238D-03, -5.018901320009D-04,  5.520233512352D-05, -3.080798536641D-06,  7.864770315002D-08, -6.357395371638D-10, &
-3.614768906120D-01,  3.710098881765D-03,  2.045814599796D-03, -8.523935993991D-04,  1.751295192861D-04, -1.944203941844D-05,  1.138888354831D-06, -3.256303793266D-08,  3.501794038444D-10, &
 2.956861321735D-02, -5.524443504504D-04, -2.457951062112D-05,  3.433179945503D-05, -1.450208898992D-06, -2.447566480782D-07,  1.375679100044D-08,  4.863880510459D-10, -3.004374374556D-11, &
 9.662490252868D-04, -1.548556801431D-04,  1.417215042439D-05, -6.444863591678D-06, -1.566028729499D-06,  4.152486680818D-07, -2.855068942744D-08,  6.081804811000D-10,  9.512865901179D-13, &
-3.543571865464D-04,  4.662969089421D-05, -1.471117766355D-05,  5.235585096328D-06, -5.779667826854D-07,  2.139729421817D-08, -3.656048425230D-10,  3.759866326965D-11, -1.486151370215D-12, &
 1.827109843671D-05, -3.179895716088D-06,  1.432429412413D-06, -5.141065080107D-07,  7.734387173369D-08, -6.163336831045D-09,  3.128313515842D-10, -1.061842444216D-11,  1.771099769640D-13 /), &
             shape(diss_ion_coef_H2plus), order=(/2,1/) )

	real(wp), private, dimension(9,9)  :: el_mom_m_coef = reshape( (/  &
-1.919275366997D+01, -1.865238346305D-02,  4.682617815803D-02, -8.932266130300D-03, -2.903882752834D-02,  3.477806471368D-03,  2.790218940150D-03, -6.908438427090D-04,  4.338681573230D-05, &
-5.947780482087D-02, -5.971382726967D-02,  5.854568958623D-03,  1.637194804434D-02, -3.291459604645D-04, -1.492225099738D-03,  1.443370523034D-04,  2.409850106077D-05, -2.849926680503D-06, &
-9.004077564531D-02,  3.225709371997D-02, -6.402554946956D-03, -1.308998760658D-03,  2.367849536658D-03, -2.633913429665D-04, -1.712112384677D-04,  4.233619961041D-05, -2.665571098691D-06, &
-1.870459871354D-02, -1.438038218134D-03,  2.190778358004D-03, -2.828299306442D-04, -4.686890203582D-07,  4.818941917867D-05, -1.902274102571D-05,  2.446426035585D-06, -9.693955463859D-08, &
 1.491376597764D-02, -1.614133948666D-03, -1.009422051586D-03, -5.326505552258D-04,  1.673303613736D-04,  6.564947466483D-05, -2.847616427622D-05,  3.578927723952D-06, -1.517016799547D-07, &
 9.563126960467D-04,  3.707880488168D-04, -7.731975035804D-05,  2.493241008729D-05, -2.434562819338D-05, -5.585591947606D-06,  4.669438326556D-06, -7.601170248698D-07,  3.823110747713D-08, &
-1.330077285945D-03, -5.353962725785D-05,  1.351235395106D-04,  6.595946297185D-05, -2.509630806820D-05, -5.474903148493D-06,  3.257943960303D-06, -4.775908920414D-07,  2.342435491722D-08, &
 2.020583687196D-04,  6.849923024482D-06, -2.550615695507D-05, -1.420945572125D-05,  6.290869308799D-06,  1.207885423899D-06, -8.361574596535D-07,  1.290522448864D-07, -6.505820743915D-09, &
-9.277851726161D-06, -4.082429350941D-07,  1.441579661485D-06,  8.431661832790D-07, -4.002257378192D-07, -7.135379893415D-08,  5.318078186713D-08, -8.385721089159D-09,  4.277930018700D-10 /), &
             shape(el_mom_m_coef), order=(/2,1/) )

real(wp), private, dimension(9,9)  :: mol_energy_coef = reshape( (/  &
-2.511426358838D+01, -1.502968736502D-03,  2.270301997818D-03, -1.160949145671D-03,  2.711890444924D-04, -3.316751545455D-05,  2.179799509766D-06, -7.292508854487D-08,  9.764136720820D-10, &
 1.039650366780D+01,  1.940526565095D-03, -2.039057105217D-03,  8.471089743180D-04, -1.668780150866D-04,  1.846170371568D-05, -1.200391601516D-06,  4.255709533045D-08, -6.263044644580D-10, &
-5.056418866002D+00,  4.267610495700D-04, -1.570825376355D-03,  1.011062331716D-03, -2.493635375898D-04,  3.107778205672D-05, -2.068798871142D-06,  7.024008304152D-08, -9.571647703521D-10, &
 1.698357023335D+00, -1.100217175513D-03,  1.346702996596D-03, -6.015963727342D-04,  1.254388145616D-04, -1.431788137516D-05,  9.254739688370D-07, -3.161858685796D-08,  4.410801074405D-10, &
-3.946794266607D-01,  8.530611978697D-04, -5.956794001881D-04,  1.440206127855D-04, -1.821423270769D-05,  1.364766339804D-06, -7.044718093836D-08,  2.445238251993D-09, -3.975970296405D-11, &
 6.332951863565D-02, -3.363804010733D-04,  1.935332922569D-04, -3.053105755056D-05,  1.434719315650D-06,  1.264447977870D-07, -1.650023620224D-08,  6.035147397334D-10, -6.735406816093D-12, &
-7.076439854566D-03,  6.801240259521D-05, -3.813794805193D-05,  6.171515920637D-06, -4.045829346605D-07, -5.237650672670D-09,  2.105913693789D-09, -9.389056833568D-11,  1.197541371030D-12, &
 5.117651399462D-04, -6.744466929271D-06,  3.834955698487D-06, -7.117247208887D-07,  7.283932745297D-08, -3.875678618801D-09,  6.547129244936D-11,  1.340983691609D-12, -3.151269189538D-14, &
-1.768573967186D-05,  2.610531177384D-07, -1.508866204608D-07,  3.137300758374D-08, -3.990100914364D-09,  3.015422105813D-10, -1.176278308629D-11,  2.089055860523D-13, -1.505656589693D-15 /), &
             shape(mol_energy_coef), order=(/2,1/) )

real(wp), private, dimension(9,9)  :: cx_Hmin_coef = reshape( (/  &
-1.690146932812D+01,  7.569370314490D-02, -1.118661556236D-01,  5.784649204408D-02, -1.430206446825D-02,  1.883300059210D-03, -1.346209157175D-04,  4.900081433053D-06, -7.105742130265D-08, &
-2.301580195362D-01,  2.981364856606D-03, -1.296888142995D-02,  9.188878355062D-03, -2.795985155376D-03,  4.355473614802D-04, -3.579321024690D-05,  1.457520878645D-06, -2.319369078632D-08, &
 2.124304411230D-02, -4.585972147659D-02,  7.447057284991D-02, -3.922380885092D-02,  9.609624588460D-03, -1.240136716983D-03,  8.671653962517D-05, -3.101461653370D-06,  4.442783018453D-08, &
 7.720995917466D-03,  3.504507942086D-03,  1.734371731330D-04, -1.347164354237D-03,  5.423527604759D-04, -9.468953600274D-05,  8.309512179236D-06, -3.552667688177D-07,  5.887954953357D-09, &
 1.331695301990D-02, -9.042026807455D-04, -4.764566765886D-03,  3.858570576628D-03, -1.128426542832D-03,  1.607204158523D-04, -1.197915401674D-05,  4.484319353024D-07, -6.656156226037D-09, &
 3.536238349067D-04, -8.011930719727D-04,  1.101704458636D-03, -5.449050513405D-04,  1.255763496307D-04, -1.495920840346D-05,  9.441566217674D-07, -2.989807912656D-08,  3.717785721362D-10, &
-1.446558546363D-03,  1.152532160685D-03, -8.305881275354D-04,  2.084267816803D-04, -1.903417990674D-05, -2.796205484739D-07,  1.584268580014D-07, -9.504026475042D-09,  1.811886563961D-10, &
 2.479021261394D-04, -2.773890711262D-04,  2.167753172783D-04, -6.195779421732D-05,  7.927649861583D-06, -4.211576616550D-07,  2.531413590874D-10,  7.572949322455D-10, -1.937737123063D-11, &
-1.248597948333D-05,  1.903633250451D-05, -1.590752591530D-05,  4.992428048704D-06, -7.522431288906D-07,  5.827438308119D-08, -2.220813567852D-09,  3.174650814148D-11,  6.296020826533D-14 /), &
             shape(cx_Hmin_coef), order=(/2,1/) )

 real(wp), private,  dimension(9)   :: da_coef = (/ &
                -2.278396332892D+01, 8.634828071751D-01, -1.686619409809D+00, 4.392288378207D-01, -4.393128035945D-01, 2.640299048385D-01, -6.748601049114D-02, 7.753368735736D-03, -3.328288267126D-04 /)

real(wp), private, dimension(9,9)  :: ion_Hmin_coef = reshape( (/  &
-3.274642366537D+01,  1.055347808907D+00, -8.644168315786D-02,  5.770739917980D-02, -1.651543971724D-02,  2.426926977738D-03, -1.852128922021D-04,  6.948553416066D-06, -1.014917161032D-07, &
 1.594755262357D+00, -1.134505488332D-01,  1.193838572515D-01, -4.779741494751D-02,  9.036602994533D-03, -8.828786882875D-04,  4.408052942176D-05, -1.018626285421D-06,  7.671244985570D-09, &
-7.947374319647D-01,  5.372231672557D-02, -1.798104638021D-02, -2.492326178844D-04,  1.070003818666D-03, -1.975024076418D-04,  1.598210863669D-05, -6.159714930603D-07,  9.185228515472D-09, &
 2.774560684070D-01, -3.731637924945D-02,  1.249720348407D-02, -2.377802775838D-03,  3.185245795525D-04, -3.766701342971D-05,  3.135633075387D-06, -1.383905482846D-07,  2.380265714001D-09, &
-9.340115304254D-02,  7.824080188667D-03, -7.880149239516D-05,  2.730699348365D-04, -1.613682461379D-04,  2.956305967893D-05, -2.493019966708D-06,  1.000180106519D-07, -1.546520999798D-09, &
 2.404236598616D-02,  8.348790303724D-04, -1.947217396578D-03,  4.228772072344D-04, -3.061264744513D-05, -4.412707867464D-07,  1.760055762971D-07, -8.605767550690D-09,  1.338507166605D-10, &
-3.635353640159D-03, -4.379659530212D-04,  4.542431412762D-04, -8.943967815733D-05,  7.191065760263D-06, -2.516431736865D-07,  5.049361112014D-09, -2.841033281170D-10,  9.491816236733D-12, &
 2.758341263855D-04,  4.578696899777D-05, -3.345082277318D-05,  3.040805346315D-06,  4.037034921179D-07, -7.745783067338D-08,  4.107873810473D-09, -5.899534309929D-11, -6.502135074988D-13, &
-7.995248003067D-06, -1.405530335553D-06,  4.938572628097D-07,  2.407555731254D-07, -8.580821961541D-08,  1.001281190560D-08, -5.295286447696D-10,  1.196080372249D-11, -7.019149004762D-14 /), &
             shape(ion_Hmin_coef), order=(/2,1/) )
contains

   real(wp) function charge_exchange( temperature )
   ! function to calculate the total charge_exchange rate coefficient [m^3/s]
      implicit none
      integer  :: j
      real(wp) :: temperature
      real(wp) :: ln_T, xj
      ! note that the temperature must be rescaled with the ratio of proton mass over ion mass used
      select case (charge_exchange_model)
      case ("AMJUEL")
         ! source AMJUEL page 38 2.2 reaction 0.1T
         ln_T = log(max((1.6726d-27/mass)*temperature,minimum_temperature,0.1d+0))
         xj = 1.0d+0
         charge_exchange = 0.0d+0
         do j = 1, 9
            charge_exchange = charge_exchange + cxa_coef(j)*xj
            xj = xj * ln_T
         enddo
         charge_exchange = exp(charge_exchange)*1.0d-6
      case ("Havlickova")
         ! source SD1D manual / Havlickova (2013)
         if( (1.6726d-27/mass)*temperature .le. 1.0 ) then
            charge_exchange = 1.0d-14
         else
            charge_exchange = 1.0d-14 * ((1.6726d-27/mass)*temperature)**(1/3)
         endif
      case ("Freeman")
         ! source Freeman and Jones CLM-R-137 Table 3
         ln_T = log(max((1.6726d-27/mass)*temperature,minimum_temperature,0.1d+0))
         xj = 1.0d+0
         charge_exchange = 0.0d+0
         do j = 1, 9
            charge_exchange = charge_exchange + cxf_coef(j)*xj
            xj = xj * ln_T
         enddo
         charge_exchange = exp(charge_exchange)*1.0d-6
      end select
      charge_exchange = switch_charge_exchange * charge_exchange
      return
   end function charge_exchange

   real(wp) function ionization( density, temperature )
   ! function to calculate the total ionization rate coefficient [m^3/s]
   implicit none
      integer  :: m, n
      real(wp) :: density, temperature
      real(wp) :: ln_n, ln_T, xm, xn
      ionization = 0.0d+0
      select case (ionization_model)
      case ("AMJUEL")
         ! the total hydrogen ionization rate according to AMJUEL 4.3 reaction 2.1.5 [m^3 / s]
         ln_n = log(density*1.0d-14)
         ln_T = log(max(temperature,minimum_temperature,0.1d+0))
         xm = 1.0d+0
         do m = 1, 9
            xn = 1.0d+0
            do n = 1, 9
               ionization = ionization + ionize_coef(n,m) * xm * xn
               xn = xn * ln_T
            enddo
            xm = xm * ln_n
         enddo
         ionization = exp(ionization) * 1.0d-6
      case ("Havlickova")
         ! source SD1D manual / Havlickova (2013)
         ! the discuntinuity at 20 eV has been removed by modifying the exponent of the temperature from -3.054 to -2.987
         if( temperature .le. 1.0d+0 ) then
            ionization = 7.638d-21 
         elseif( temperature .lt. 20.0d+0 ) then
            ionization = 1.0d+1**(-6.0d+0 - 15.72d+0 * exp(-log10(temperature)) + 1.603d+0*exp(-log10(temperature)**2) )* temperature**(-2.987d+0)
         else
            ionization = 5.875d-12 * temperature**(-0.5151d+0) * 10**( -2.563d+0 / log10(temperature) )
         endif
      case ("Freeman")
         ! source Freeman and Jones CLM-R-137 Table 3
         ln_T = log(max(temperature,minimum_temperature,0.1d+0))
         xn = 1.0d+0
         ionization = 0.0d+0
         do n = 1, 7
            ionization = ionization + ifj_coef(n)*xn
            xn = xn * ln_T
         enddo
         ionization = exp(ionization)*1.0d-6
      end select
      ionization = switch_ionization * ionization
      return
   end function ionization

   real(wp) function excitation( density, temperature )
   ! function to calculate the efective excitation rate coefficient [eV m^3/s]
   ! this is a measure of the effective energy loss per ionization event (so the low density high T limit is 13.6 * ionization rate)
   ! source SD1D code / Havlickova (2013)
   implicit none
      integer  :: m, n
      real(wp) :: density, temperature
      real(wp) :: ln_n, ln_T, xm, xn, Y
      excitation = 0.0d+0
      if( case_AMJUEL ) then
         ! the total hydrogen effective cooling rate by ionization and radiation according to AMJUEL 10.2 reaction 2.1.5  [eV m^3 / s]
         ln_n = log(density*1.0d-14)
         ln_T = log(max(temperature,minimum_temperature,0.1d+0))
         xm = 1.0d+0
         do m = 1, 9
            xn = 1.0d+0
            do n = 1, 9
               excitation = excitation + excite_coef(n,m) * xm * xn
               xn = xn * ln_T
            enddo
            xm = xm * ln_n
         enddo
         excitation = exp(excitation) * 1.0d-6
      else
         if( temperature .lt. 1.0d+0 ) then
            Y = 1.02d+1 / 1.0d+0 
         else
            Y = 1.02d+1 / temperature 
         endif
         excitation = 4.90d-13 / (0.28d+0+Y) *exp(-Y)*sqrt(Y*(1.0d+0+Y)) + 13.6d+0 * ionization(density, temperature) ! added to be consistent with SD1D
      endif
      excitation = switch_excitation * excitation
      return
   end function excitation

   real(wp) function recombination( density, temperature )
   ! function to calculate the total recombination rate coefficient [m^3/s]
   ! fit function from AMJUEL 4.4 reaction 2.1.8 total rate including three-body recombination
   ! note that in the AMJUEL fits densities are normalized to 10^+14 m^-3
      implicit none
      integer  :: m, n
      real(wp) :: density, temperature
      real(wp) :: ln_n, ln_T, xm, xn
      recombination = 0.0d+0
      select case (recombination_model)
      case ("AMJUEL")
         ln_n = log(density*1.0d-14)
         ln_T = log(max(temperature,minimum_temperature,0.1d+0))
         xm = 1.0d+0
         do m = 1, 9
            xn = 1.0d+0
            do n = 1, 9
               recombination = recombination + recomb_coef(n,m) * xm * xn
               xn = xn * ln_T
            enddo
            xm = xm * ln_n
         enddo
         recombination = switch_recombination * exp(recombination) * 1.0d-6
      case ("Nakazawa")
         ! use radiative recombination rate from Gordeev et al. 1977 JETP 25 204 (ref 18 of Nakazawa)
         recombination = 1.27d-19 * (13.6d+0/temperature)**1.5d+0 / ((13.6d+0/temperature) + 0.59d+0)
         ! plus the 3 body recombination rate from Hinnov et al. 1962 Phys Rev 125 795 (ref 19 of Nakazawa)
         recombination = recombination + 5.6d-39 * temperature**(-4.5d+0) * density
         recombination = switch_recombination * recombination
      end select
   end function recombination

   real(wp) function recombenergy( density, temperature )
   ! function to calculate the efective electron cooling rate from recombination [eV m^3/s]
   ! this is a measure of the effective energy loss per recombination event (so the low density high T limit is 13.6 * ionization rate)
   implicit none
      integer  :: m, n
      real(wp) :: density, temperature
      real(wp) :: ln_n, ln_T, xm, xn, Y
      recombenergy = 0.0d+0
      ! the total hydrogen effective cooling rate by ionization and radiation according to AMJUEL 10.2 reaction 2.1.5  [eV m^3 / s]
      ln_n = log(density*1.0d-14)
      ln_T = log(max(temperature,minimum_temperature,0.1d+0))
      xm = 1.0d+0
      do m = 1, 9
         xn = 1.0d+0
         do n = 1, 9
            recombenergy = recombenergy + recnrg_coef(n,m) * xm * xn
            xn = xn * ln_T
         enddo
         xm = xm * ln_n
      enddo
      recombenergy = exp(recombenergy) * 1.0d-6 ! - 13.6 * recombination( density, temperature ) ! last part to be added explicitly in physics_routines%sources
      recombenergy = switch_recombenergy * recombenergy
      return
   end function recombenergy

   real(wp) function impurity_radiation( temperature,itime,ix) 
      ! function to calculate the effective loss rate due to inpurity radiation rate coefficient [eV m^3/s]
      implicit none
      real(wp) :: temperature, log_T 
      integer :: itime, iz, ix
      impurity_radiation = 0.0d+0
      
      if( case_AMJUEL ) then
         ! fit function Post et al. 1977 extrapolated below its validity range of 3 eV
         log_T = log10(max(temperature,minimum_temperature,0.1d+0)/1.0d+3)   ! from eV to keV
         do iz = 1, num_impurities
                
         impurity_radiation = post_radiation(temperature,log_T, impurity_Z(iz)) * D_imp_con(iz,itime) * prf_imp_con(iz,ix) + impurity_radiation
                                         ! temperature is in eV and log_T in keV  
         enddo
      else
         ! use the fit function from SD1D for carbon
         iz = 1
         impurity_radiation = 2.0d-31/e_charge * (max(temperature,1.0d+0)/1.0d+1)**3 / (1.0d+0 + (max(temperature,1.0d+0)/1.0d+1)**4.5d+0)
         impurity_radiation = impurity_radiation * D_imp_con(1,itime)
      endif
      return
   end function impurity_radiation

   real(wp) function momentum_transfer_atoms(temperature, velocity)
	 !function to calculate the effective momentum loss rate due to elastic ion-electron collisions
      implicit none
      integer  :: m, n
      real(wp) :: temperature, velocity
      real(wp) :: ln_T, xm, xn, ln_E, E
      ! note that the temperature must be rescaled with the ratio of proton mass over ion mass used
	 ln_T = log(max((1.6726d-27/mass)*temperature,minimum_temperature,0.1d+0))
	 E = mass * velocity * velocity / (2.0d+0 * 1.602d-19)
	if (E.lt.0.1) then
	E = 0.1d0
	endif
	 ln_E = log(E)
         xm = 1.0d+0
         momentum_transfer_atoms = 0.0d+0
         do m = 1,9
	    xn = 1.0d+0
	    do n = 1,9
               momentum_transfer_atoms = momentum_transfer_atoms + el_mom_a_coef(n,m) * xn * xm
               xn = xn * ln_T
	    enddo
	    xm = xm * ln_E
         enddo
         momentum_transfer_atoms = exp(momentum_transfer_atoms)*1.0d-6
      momentum_transfer_atoms = switch_momentum_transfer_atoms * momentum_transfer_atoms
      return
   end function momentum_transfer_atoms

   real(wp) function ionization_m( density, temperature )
   ! function to calculate the total  molecular ionization rate coefficient [m^3/s]
   implicit none
      integer  :: m, n
      real(wp) :: density, temperature
      real(wp) :: ln_n, ln_T, xm, xn
      ionization_m = 0.0d+0
         ! the total hydrogen molecule ionization rate according to AMJUEL 4.3 reaction 2.1.5 [m^3 / s]
         ln_n = log(density*1.0d-14)
         ln_T = log(max(temperature,minimum_temperature,0.1d+0))
         xm = 1.0d+0
         do m = 1, 9
            xn = 1.0d+0
            do n = 1, 9
               ionization_m = ionization_m + iona_coef_m(n,m) * xm * xn
               xn = xn * ln_T
            enddo
            xm = xm * ln_n
         enddo
         ionization_m = exp(ionization_m) * 1.0d-6
      ionization_m = switch_ionization_molecules * ionization_m
      return
   end function ionization_m

  real(wp) function charge_exchange_Hmin( density, temperature )
   ! function to calculate the total charge exchange rate coefficient on H⁻ [m^3/s]
   implicit none
      integer  :: m, n
      real(wp) :: density, temperature
      real(wp) :: ln_n, ln_T, xm, xn
      charge_exchange_Hmin = 0.0d+0
         ! the total H⁻ charge exchange rate according to AMJUEL 4.3 reaction 2.1.5 [m^3 / s]
         ln_n = log(density*1.0d-14)
         ln_T = log(max(temperature*0.5d+0,minimum_temperature,0.1d+0))
         xm = 1.0d+0
         do m = 1, 9
            xn = 1.0d+0
            do n = 1, 9
               charge_exchange_Hmin = charge_exchange_Hmin + cx_Hmin_coef(n,m) * xm * xn
               xn = xn * ln_T
            enddo
            xm = xm * ln_n
         enddo
         charge_exchange_Hmin = exp(charge_exchange_Hmin) * 1.0d-6
      charge_exchange_Hmin = switch_charge_exchange_Hmin * charge_exchange_Hmin
      return
   end function charge_exchange_Hmin

real(wp) function ionization_Hmin( density, temperature )
   ! function to calculate the total  molecular ionization rate coefficient [m^3/s]
   implicit none
      integer  :: m, n
      real(wp) :: density, temperature
      real(wp) :: ln_n, ln_T, xm, xn
      ionization_Hmin = 0.0d+0
         ! the total hydrogen molecule ionization rate according to AMJUEL 4.3 reaction 2.1.5 [m^3 / s]
         ln_n = log(density*1.0d-14)
         ln_T = log(max(temperature*0.5d+0,minimum_temperature,0.1d+0))
         xm = 1.0d+0
         do m = 1, 9
            xn = 1.0d+0
            do n = 1, 9
               ionization_Hmin = ionization_Hmin + ion_Hmin_coef(n,m) * xm * xn
               xn = xn * ln_T
            enddo
            xm = xm * ln_n
         enddo
         ionization_Hmin = exp(ionization_Hmin) * 1.0d-6
      ionization_Hmin = switch_ionization_Hmin * ionization_Hmin
      return
   end function ionization_Hmin

   real(wp) function dissociation_m( density, temperature )
   ! function to calculate the total  molecular dissociation rate coefficient [m^3/s]
   implicit none
      integer  :: m, n
      real(wp) :: density, temperature
      real(wp) :: ln_n, ln_T, xm, xn
      dissociation_m = 0.0d+0
         ln_n = log(density*1.0d-14)
         ln_T = log(max(temperature,minimum_temperature,0.1d+0))
         xm = 1.0d+0
         do m = 1, 9
            xn = 1.0d+0
            do n = 1, 9
               dissociation_m = dissociation_m + diss_coef_m(n,m) * xm * xn
               xn = xn * ln_T
            enddo
            xm = xm * ln_n
         enddo
         dissociation_m = exp(dissociation_m) * 1.0d-6
      dissociation_m = switch_dissociation_molecules * dissociation_m
      return
   end function dissociation_m

   real(wp) function charge_exchange_m( temperature )
   ! function to calculate the total charge_exchange rate coefficient [m^3/s]
      implicit none
      integer  :: j
      real(wp) :: temperature
      real(wp) :: ln_T, xj
      ! note that the temperature must be rescaled with the ratio of proton mass over ion mass used
         ln_T = log(max((1.6726d-27/mass)*temperature,minimum_temperature,0.1d+0))
         xj = 1.0d+0
         charge_exchange_m = 0.0d+0
         do j = 1, 9
            charge_exchange_m = charge_exchange_m + cxa_coef_m(j)*xj
            xj = xj * ln_T
         enddo
         charge_exchange_m = exp(charge_exchange_m)*1.0d-6
      charge_exchange_m = switch_charge_exchange_molecules * charge_exchange_m
      return
   end function charge_exchange_m

   real(wp) function dissociative_attachment( temperature )
   ! function to calculate the total charge_exchange rate coefficient [m^3/s]
      implicit none
      integer  :: j
      real(wp) :: temperature
      real(wp) :: ln_T, xj
      ! note that the temperature must be rescaled with the ratio of proton mass over ion mass used
         ln_T = log(max((1.6726d-27/mass)*temperature,minimum_temperature,0.1d+0))
         xj = 1.0d+0
         dissociative_attachment = 0.0d+0
         do j = 1, 9
            dissociative_attachment = dissociative_attachment + da_coef(j)*xj
            xj = xj * ln_T
         enddo
         dissociative_attachment = exp(dissociative_attachment)*1.0d-6
      dissociative_attachment = switch_dissociative_attachment * dissociative_attachment
      return
   end function dissociative_attachment

   real(wp) function dissociation_H2plus( density, temperature )
   ! function to calculate the total  molecular ionization rate coefficient [m^3/s]
   implicit none
      integer  :: m, n
      real(wp) :: density, temperature
      real(wp) :: ln_n, ln_T, xm, xn
      dissociation_H2plus = 0.0d+0
         ! the total hydrogen molecule ionization rate according to AMJUEL 4.3 reaction 2.1.5 [m^3 / s]
         ln_n = log(density*1.0d-14)
         ln_T = log(max(temperature,minimum_temperature,0.1d+0))
         xm = 1.0d+0
         do m = 1, 9
            xn = 1.0d+0
            do n = 1, 9
               dissociation_H2plus = dissociation_H2plus + diss_coef_H2plus(n,m) * xm * xn
               xn = xn * ln_T
            enddo
            xm = xm * ln_n
         enddo
         dissociation_H2plus = exp(dissociation_H2plus) * 1.0d-6
      dissociation_H2plus = switch_dissociation_H2plus * dissociation_H2plus
      return
   end function dissociation_H2plus

   real(wp) function dissociative_recombination_H2plus( density, temperature )
   ! function to calculate the total  molecular ionization rate coefficient [m^3/s]
   implicit none
      integer  :: m, n
      real(wp) :: density, temperature
      real(wp) :: ln_n, ln_T, xm, xn
      dissociative_recombination_H2plus = 0.0d+0
         ! the total hydrogen molecule ionization rate according to AMJUEL 4.3 reaction 2.1.5 [m^3 / s]
         ln_n = log(density*1.0d-14)
         ln_T = log(max(temperature,minimum_temperature,0.1d+0))
         xm = 1.0d+0
         do m = 1, 9
            xn = 1.0d+0
            do n = 1, 9
               dissociative_recombination_H2plus = dissociative_recombination_H2plus + diss_rec_coef_H2plus(n,m) * xm * xn
               xn = xn * ln_T
            enddo
            xm = xm * ln_n
         enddo
         dissociative_recombination_H2plus = exp(dissociative_recombination_H2plus) * 1.0d-6
      dissociative_recombination_H2plus = switch_dissociative_recombination_H2plus * dissociative_recombination_H2plus
      return
   end function dissociative_recombination_H2plus

   real(wp) function dissociative_ionization_H2plus( density, temperature )
   ! function to calculate the total  molecular ionization rate coefficient [m^3/s]
   implicit none
      integer  :: m, n
      real(wp) :: density, temperature
      real(wp) :: ln_n, ln_T, xm, xn
      dissociative_ionization_H2plus = 0.0d+0
         ! the total hydrogen molecule ionization rate according to AMJUEL 4.3 reaction 2.1.5 [m^3 / s]
         ln_n = log(density*1.0d-14)
         ln_T = log(max(temperature,minimum_temperature,0.1d+0))
         xm = 1.0d+0
         do m = 1, 9
            xn = 1.0d+0
            do n = 1, 9
               dissociative_ionization_H2plus = dissociative_ionization_H2plus + diss_ion_coef_H2plus(n,m) * xm * xn
               xn = xn * ln_T
            enddo
            xm = xm * ln_n
         enddo
         dissociative_ionization_H2plus = exp(dissociative_ionization_H2plus) * 1.0d-6
      dissociative_ionization_H2plus = switch_dissociative_ionization_H2plus * dissociative_ionization_H2plus
      return
   end function dissociative_ionization_H2plus

   real(wp) function energy_molecules( density, temperature )
   ! function to calculate the total  molecular ionization rate coefficient [m^3/s]
   implicit none
      integer  :: m, n
      real(wp) :: density, temperature
      real(wp) :: ln_n, ln_T, xm, xn
      energy_molecules = 0.0d+0
         ! the total hydrogen molecule ionization rate according to AMJUEL 4.3 reaction 2.1.5 [m^3 / s]
         ln_n = log(density*1.0d-14)
         ln_T = log(max(temperature,minimum_temperature,0.1d+0))
         xm = 1.0d+0
         do m = 1, 9
            xn = 1.0d+0
            do n = 1, 9
               energy_molecules = energy_molecules + mol_energy_coef(n,m) * xm * xn
               xn = xn * ln_T
            enddo
            xm = xm * ln_n
         enddo
         energy_molecules = exp(energy_molecules) * 1.0d-6
      energy_molecules = switch_energy_molecules * energy_molecules
      return
   end function energy_molecules

   real(wp) function momentum_transfer_molecules(temperature, velocity)
	 !function to calculate the effective momentum loss rate due to elastic ion-molecule collisions
      implicit none
      integer  :: m, n
      real(wp) :: temperature, velocity
      real(wp) :: ln_T, xm, xn, ln_E, E
      ! note that the temperature must be rescaled with the ratio of proton mass over ion mass used
	 ln_T = log(max((1.6726d-27/mass)*temperature,minimum_temperature,0.1d+0))
	 E = 2.0d+0 * mass * velocity * velocity / (2.0d+0 * 1.602d-19)
	if (E.lt.0.1) then
	E = 0.1d0
	endif
	 ln_E = log(E)
         xm = 1.0d+0
         momentum_transfer_molecules = 0.0d+0
         do m = 1,9
	    xn = 1.0d+0
	    do n = 1,9
               momentum_transfer_molecules = momentum_transfer_molecules + el_mom_m_coef(n,m) * xn * xm
               xn = xn * ln_T
	    enddo
	    xm = xm * ln_E
         enddo
         momentum_transfer_molecules = exp(momentum_transfer_molecules)*1.0d-6
      momentum_transfer_molecules = switch_momentum_transfer_molecules * momentum_transfer_molecules
      return
   end function momentum_transfer_molecules



end module reaction_rates
!         impurity_radiation = post_radiation(temperature,log_T, impurity_Z(iz)) * D_imp_con(iz,itime) * prf_imp_con(iz,ix)  + impurity_radiation

      
      !   impurity_radiation = impurity_radiation *D_imp_con(1,itime)
 
